# BOT-BUSINESS V2.0

**Telegram-бот для записи клиентов** (барбершопы, салоны красоты, мастера услуг)

## Возможности

### Для клиентов:
- Запись на услуги с выбором даты и времени
- Выбор мастера (если включен staff-режим)
- Просмотр своих записей
- Изменение записей (дата/время, услуга)
- Отмена записей
- Отправка номера телефона через контакт
- FAQ и контакты

### Для администраторов:
- Уведомления о новых записях
- Уведомления об изменениях и отменах
- История клиента в каждом уведомлении
- Админ-панель с статистикой
- Просмотр всех заказов
- База клиентов

## Быстрый старт

### 1. Требования

- Python 3.9+ (рекомендуется 3.11)
- pip

### 2. Установка

```bash
# Клонируйте репозиторий
git clone https://github.com/justinjohnson25401-dev/digital_admin_bot_beauty.git
cd digital_admin_bot_beauty

# Создайте виртуальное окружение (рекомендуется)
python -m venv venv

# Активация на Windows:
venv\Scripts\activate

# Активация на Linux/Mac:
source venv/bin/activate

# Установите зависимости
pip install -r requirements.txt
```

### 3. Настройка

Запустите интерактивный установщик:

```bash
python setup.py
```

Установщик запросит:
- TOKEN бота (от @BotFather)
- Ваш Telegram ID
- Название бизнеса
- Уникальный slug

И автоматически создаст:
- `.env` с токенами
- `configs/client_lite.json` с настройками
- База данных SQLite

### 4. Запуск

```bash
# Основной бот (для клиентов)
python main.py --config configs/client_lite.json

# Админ-бот (опционально)
python admin_bot/main.py --config configs/client_lite.json
```

## Запуск тестов

```bash
# Установка dev-зависимостей
pip install -r requirements-dev.txt

# Запуск тестов
pytest tests -v

# Запуск с покрытием
pytest tests -v --cov=.
```

Подробные результаты тестирования см. в [TEST_RESULTS.md](TEST_RESULTS.md)

## Структура проекта

```
digital_admin_bot_beauty/
├── handlers/              # Обработчики сообщений
│   ├── booking.py        # FSM бронирования (выбор услуги/мастера/даты/времени)
│   ├── start.py          # Команда /start и главное меню
│   └── mybookings.py     # Просмотр/отмена записей
│
├── states/               # FSM состояния
│   └── booking.py        # BookingState: все состояния процесса записи
│
├── utils/                # Утилиты
│   ├── db_manager.py     # Работа с SQLite (атомарные операции, защита от race condition)
│   ├── calendar.py       # Генерация календарной клавиатуры
│   ├── validators.py     # Валидация данных (телефоны, названия, цены)
│   ├── privacy.py        # Маскировка персональных данных
│   └── notify.py         # Уведомления админам
│
├── admin_bot/            # Админ-панель (отдельный бот)
│   └── main.py
│
├── admin_handlers/       # Обработчики админ-бота
│   └── business_settings.py
│
├── configs/              # Конфигурации
│   └── client_lite.json  # Настройки бизнеса
│
├── tests/                # Unit-тесты
│   ├── test_db_manager.py
│   ├── test_booking_logic.py
│   ├── test_validators.py
│   ├── test_calendar.py
│   ├── test_privacy.py
│   └── test_logger.py
│
├── main.py               # Точка входа основного бота
├── logger.py             # Настройка логирования с маскировкой данных
├── setup.py              # Интерактивный установщик
├── requirements.txt      # Зависимости
└── requirements-dev.txt  # Dev-зависимости (pytest)
```

## Конфигурация

### Редактирование услуг

Откройте `configs/client_lite.json`:

```json
{
  "services": [
    {"id": "service1", "name": "Стрижка", "price": 1200, "duration": 60},
    {"id": "service2", "name": "Стрижка + борода", "price": 1800, "duration": 90}
  ]
}
```

### График работы

```json
{
  "booking": {
    "work_start": 10,
    "work_end": 20,
    "slot_duration": 60
  }
}
```

### Мастера (staff-режим)

```json
{
  "staff": {
    "enabled": true,
    "masters": [
      {
        "id": "master1",
        "name": "Анна",
        "active": true,
        "services": ["service1", "service2"],
        "closed_dates": [
          {"date": "2026-01-15", "reason": "Отпуск"}
        ]
      }
    ]
  }
}
```

### Функции (включить/выключить)

```json
{
  "features": {
    "enable_slot_booking": true,
    "enable_admin_notify": true,
    "require_phone": true,
    "ask_comment": true
  }
}
```

## Безопасность

### Защита от race condition

Бронирование слотов защищено от race condition:
- Проверка доступности и создание записи выполняются атомарно в одной транзакции
- При попытке забронировать занятый слот пользователь получает понятное сообщение

### Маскировка данных в логах

Логгер автоматически маскирует:
- Токены ботов: `1234567890:***TOKEN_MASKED***`
- Телефоны: `+7999***4567`
- Email: `***@example.com`

### Хранение секретов

Токены и чувствительные данные хранятся только в:
- `.env` файле (не коммитится в git)
- Переменных окружения

## Админ-панель

### Возможности:

1. **Статистика** - заказы за день/неделю/месяц, выручка
2. **Заказы** - список на сегодня/завтра/неделю
3. **Клиенты** - база клиентов, топ-10
4. **Настройки** - редактирование названия, часов работы, слотов

### Запуск:

```bash
python admin_bot/main.py --config configs/client_lite.json
```

## Логирование

Все события логируются в файл `bot.log` с ротацией (5 MB, 3 backup-файла).

Уровни:
- INFO - обычные события
- WARNING - конфликты бронирования
- ERROR - ошибки
- CRITICAL - критические ошибки

## Changelog

### Version 2.1.0 (02.01.2026)
- Стабилизирован FSM бронирования (полный flow от /start до подтверждения)
- Добавлена защита от race condition при бронировании
- Добавлены валидаторы для админ-панели
- Улучшено логирование с маскировкой персональных данных
- Расширено тестовое покрытие (73 теста)

### Version 2.0.1 (26.12.2025)
- Исправлена ошибка дублирования сообщения о комментарии
- Исправлена кнопка "Назад" в редактировании записей
- Добавлен интерактивный установщик `setup.py`
- Добавлен админ-бот с статистикой

### Version 2.0.0 (25.12.2025)
- Полная переработка архитектуры на aiogram 3.x
- Система бронирования по слотам
- Редактирование записей
- Отправка номера через контакт

## Требования

- Python 3.9+ (рекомендуется 3.11)
- aiogram 3.15.0+
- SQLite3 (встроен в Python)

## Лицензия

MIT License - используйте свободно для коммерческих целей.

---

**Версия:** 2.1.0
**Дата:** 02.01.2026
**Статус:** Production Ready
