# BOT-BUSINESS V2.0

**Telegram-бот для записи клиентов** (барбершопы, салоны красоты, мастера услуг)

## Возможности

### Для клиентов:
- Запись на услуги с выбором даты и времени
- Выбор мастера (если включен staff-режим)
- Просмотр своих записей
- Изменение записей (дата/время, услуга)
- Отмена записей
- Отправка номера телефона через контакт
- FAQ и контакты

### Для администраторов:
- Уведомления о новых записях
- Уведомления об изменениях и отменах
- История клиента в каждом уведомлении
- Админ-панель с статистикой
- Просмотр всех заказов
- База клиентов

## Быстрый старт

### 1. Требования

- Python 3.9+ (рекомендуется 3.11)
- pip

### 2. Установка

```bash
# Клонируйте репозиторий
git clone https://github.com/justinjohnson25401-dev/digital_admin_bot_beauty.git
cd digital_admin_bot_beauty

# Создайте виртуальное окружение (рекомендуется)
python -m venv venv

# Активация на Windows:
venv\Scripts\activate

# Активация на Linux/Mac:
source venv/bin/activate

# Установите зависимости
pip install -r requirements.txt
```

### 3. Настройка

Запустите интерактивный установщик:

```bash
python setup.py
```

Установщик запросит:
- TOKEN бота (от @BotFather)
- Ваш Telegram ID
- Название бизнеса
- Уникальный slug

И автоматически создаст:
- `.env` с токенами
- Директорию `config/` с файлами настроек
- Базу данных SQLite

### 4. Запуск

```bash
# Основной бот (для клиентов)
python main.py --config-dir config

# Админ-бот (опционально)
python admin_bot/main.py --config-dir config
```

## Запуск тестов

```bash
# Установка dev-зависимостей
pip install -r requirements-dev.txt

# Запуск тестов
python run_tests.py
```

Подробные результаты тестирования см. в [TEST_RESULTS.md](TEST_RESULTS.md)

## Структура проекта

```
digital_admin_bot_beauty/
├── config/                 # Директория с файлами конфигурации (JSON)
│   ├── main.json           # Основные настройки (название, slug, токен)
│   ├── booking.json        # Настройки записи (часы работы, длительность слота)
│   ├── services.json       # Список услуг
│   ├── messages.json       # Все тексты бота
│   └── ...                 # Другие файлы конфигурации
│
├── handlers/               # Обработчики сообщений
│   ├── booking.py          # FSM бронирования
│   ├── start.py            # Команда /start и главное меню
│   └── mybookings.py       # Просмотр/отмена записей
│
├── utils/                  # Утилиты
│   ├── db.py               # Управление БД
│   ├── config_loader.py    # Загрузка и объединение конфигурации
│   └── ...
│
├── tests/                  # Unit-тесты
├── main.py                 # Точка входа основного бота
├── logger.py               # Настройка логирования
├── setup.py                # Интерактивный установщик
└── requirements.txt        # Зависимости
```

## Конфигурация

Конфигурация теперь разделена на несколько файлов в директории `config/` для удобства.

### Редактирование услуг (`config/services.json`)

```json
{
  "services": [
    {"id": "service1", "name": "Стрижка", "price": 1200, "duration": 60},
    {"id": "service2", "name": "Стрижка + борода", "price": 1800, "duration": 90}
  ]
}
```

### График работы (`config/booking.json`)

```json
{
  "booking": {
    "work_start": 10,
    "work_end": 20,
    "slot_duration": 60
  }
}
```

### Сообщения бота (`config/messages.json`)

```json
{
    "messages": {
        "welcome": "Добро пожаловать в {business_name}!",
        "select_service": "Пожалуйста, выберите услугу:"
    }
}
```

## Безопасность

### Защита от race condition

Бронирование слотов защищено от race condition: проверка доступности и создание записи выполняются атомарно в одной транзакции.

### Маскировка данных в логах

Логгер автоматически маскирует чувствительные данные (токены, телефоны, email).

### Хранение секретов

Токены и другие секреты хранятся в файле `.env` (игнорируется Git) и загружаются как переменные окружения.


## Changelog

### Version 2.2.0 (Дата)
- **Рефакторинг системы конфигурации.**
  - Конфигурация перенесена из одного JSON файла в модульную структуру в директории `config/`.
  - Это упрощает управление настройками и позволяет изменять их "на лету".
  - Добавлена фоновая задача, которая отслеживает изменения в `config/` и автоматически перезагружает настройки без перезапуска бота.

### Version 2.1.0 (02.01.2026)
- Стабилизирован FSM бронирования
- Добавлена защита от race condition при бронировании
- Улучшено логирование с маскировкой персональных данных

### Version 2.0.1 (26.12.2025)
- Исправлены мелкие ошибки
- Добавлен интерактивный установщик `setup.py`
- Добавлен админ-бот

### Version 2.0.0 (25.12.2025)
- Полная переработка архитектуры на aiogram 3.x

---

**Версия:** 2.2.0
**Статус:** Development
